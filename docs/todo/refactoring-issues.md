# Harvester 리팩토링 이슈 목록

> 작성일: 2026-01-23
> 상태: 대기 중

---

## 1. 코드 품질 저하 (덕지덕지)

**현상:**
- 급하게 기능 추가하면서 코드가 지저분해짐
- 임시 해결책들이 누적됨
- 일관성 없는 패턴 혼재

**해결 방향:**
- [x] 전체 코드 리뷰 후 정리 대상 파일 목록 작성 (Phase 1: 2개 파일)
- [x] AGENTS.md 코딩 컨벤션 재적용 (Phase 1: ScoreCalculationStep, StatisticsAggregationStep)
  - ✅ 삼항 연산자 제거: 9개 → 0개 (100% 준수)
  - ✅ 메서드 길이: 모든 메서드 ≤10줄 (2개 파일)
- [ ] 중복 코드 추출 및 공통화 (Phase 2 예정)

---

## 2. 데이터 수집 누락

**현상:**
- 일부 데이터가 수집되지 않음
- 어떤 데이터가 누락되는지 파악 필요

**조사 필요:**
- [ ] 어떤 종류의 데이터가 누락되는지 확인 (PR? Issue? Commit?)
- [ ] GraphQL 쿼리에서 빠진 필드 있는지 점검
- [ ] Step 실행 순서/의존성 문제 여부 확인

**해결 방향:**
- [ ] 누락 케이스 재현 및 로깅 추가
- [ ] 수집 완료 검증 로직 추가

---

## 3. 최근 활동 내역 수집 누락

**현상:**
- 최근 활동 (Recent Activity) 데이터가 전부 누락됨

**조사 필요:**
- [ ] RecentActivityStep 존재 여부 확인
- [ ] 어떤 활동 유형이 누락되는지 파악
- [ ] 페이지네이션 문제인지, 필터링 문제인지 확인

**해결 방향:**
- [ ] 활동 유형별 수집 로직 점검
- [ ] 누락 케이스에 대한 테스트 추가

---

## 4. BE-GH 간 엔티티/코드 중복

**현상:**
- 동일한 Entity 클래스가 Backend와 Harvester 양쪽에 존재
- 한쪽 수정 시 다른쪽 동기화 누락 가능성

**문제 파일들 (예상):**
- User / GithubUser 엔티티
- MongoDB Document 클래스들
- DTO 클래스들

**해결 방향:**
- [x] 공유 모듈 (shared library) 분리
- [x] 변경 시 양쪽 동기화 체크리스트 문서화

**해결 완료 (2026-01-27):**
- 공통 코드는 common 모듈로 분리 완료
- Harvester에서 모든 계산 수행 (통계, 챌린지 등)
- BE-GH 간 중복 제거됨

---

## 5. 대형 레포 타임아웃 / 조용한 실패

**현상:**
- 큰 레포지토리 수집 시 타임아웃 발생
- 실패해도 에러로 기록되지 않는 경우 있음 (silent failure)

**조사 필요:**
- [ ] 어느 Step에서 타임아웃 발생하는지 확인
- [ ] GraphQL 쿼리 타임아웃 설정 확인
- [ ] Exception이 catch만 되고 rethrow 안 되는 곳 찾기

**해결 방향:**
- [ ] 페이지네이션 개선 (한 번에 적은 양씩)
- [ ] 레포 크기 기반 분할 처리
- [ ] 실패 시 명확한 에러 로깅 및 Job 상태 반영
- [ ] retry 정책 추가

---

## 6. 복잡한 코드 흐름 (스파게티)

**현상:**
- 코드 흐름 추적이 어려움
- 어디서 뭐가 실행되는지 파악 힘듦
- 디버깅 시간 증가

**문제 영역 (예상):**
- Step 간 데이터 전달 방식
- Job/Step 구성 로직
- Redis Stream 메시지 처리 흐름

**해결 방향:**
- [ ] 아키텍처 다이어그램 작성
- [ ] Step 간 명확한 인터페이스 정의
- [x] 복잡한 메서드 분리 및 단순화 (Phase 1: 2개 파일 완료)
  - ✅ ScoreCalculationStep: 4개 긴 메서드 분할
  - ✅ StatisticsAggregationStep: 3개 긴 메서드 분할
- [ ] 흐름 추적용 로깅 개선

---

## 7. BE-GH 통신 구조 문제

**현상:**
- Backend와 Harvester 간 통신에 문제 많음
- 어떤 문제인지 구체화 필요

**조사 필요:**
- [x] 현재 통신 방식 정리 (Redis Stream)
- [x] stream이 안비워짐
- [x] trigger에 쌓여도 실행 안됨 (이게 메시지 유실인가?)
- [x] 메시지 유실 케이스 확인

**해결 방향:**
- [x] 통신 프로토콜 단순화 (다른 프로토콜을 알아보던지 해야할듯)
- [x] 메시지 포맷 명세 문서화
- [x] 실패 시 재시도 / 복구 메커니즘 강화

**해결 완료 (2026-01-27):**
- Redis Stream 완전 제거
- Redis Sorted Set 기반 job queue로 교체
- 메시지 유실 문제 해결 (영속적 큐)
- Trigger 실행 안 되는 문제 해결 (polling + dequeue)
- 중복 실행 방지 로직 추가 (JobExplorer 사용)
- Rate limit 인지 retry 메커니즘 구현

---

## 8. 챌린지 업데이트 요청 발송 확인 불가

**현상:**
- Harvester가 BE로 챌린지 업데이트 요청을 보내는지 확인이 안 됨
- 로그가 눈에 안 띄어서 정상 동작 여부 파악 불가
- 요청이 실제로 나가는지, 실패하는지 모름

**조사 필요:**
- [x] ChallengeCheckPublisher (또는 유사 클래스) 위치 확인
- [x] 현재 로깅 수준 확인
- [x] 실제 Redis Pub/Sub 메시지 발행 여부 확인

**해결 방향:**
- [x] 챌린지 요청 발송 시 명확한 INFO 레벨 로그 추가
- [x] 4번 항목의 해결방안인 공유 모듈 (shared library) 분리를 적용
- [x] 공통 모듈 적용 후 Harvester에서 계산

**해결 완료 (2026-01-27):**
- BE-GH 통신 불필요 (Harvester에서 모든 계산 수행)
- 챌린지 계산을 Harvester의 계산 스텝에서 직접 처리

---

## 9. BE 챌린지 요청 처리 검증 필요

**현상:**
- Backend가 챌린지 요청을 받아서 제대로 처리하는지 확인 안 됨
- GH → BE 요청은 나가는 것 같은데 BE에서 실제로 처리되는지 의문

**조사 필요:**
- [x] BE의 챌린지 요청 수신 로직 위치 확인 (KOSP-Backend)
- [x] BE에서 수신 로그 남기고 있는지 확인
- [x] 챌린지 상태 업데이트가 DB에 반영되는지 확인

**해결 방향:**
- [x] 4번 항목의 해결방안인 공유 모듈 (shared library) 분리를 적용
- [x] 공통 모듈 적용 후 Harvester에서 계산

**해결 완료 (2026-01-27):**
- BE-GH 통신 불필요 (Harvester에서 모든 계산 수행)
- 챌린지 계산을 Harvester의 계산 스텝에서 직접 처리

---

## 우선순위 (제안)

| 순위 | 이슈 | 이유 |
|----|------|------|
| 1  | #4 엔티티 중복 | 유지보수 리스크 |
| 2  | #7 BE-GH 통신 | 시스템 안정성 |
| 3  | #1, #6 코드 품질 | 장기적 생산성 |
| 4  | #8, #9 챌린지 요청 검증 | 기능 동작 확인 불가 |
| 5  | #5 대형 레포 타임아웃 | 데이터 손실 |
| 6  | #2, #3 데이터 수집 누락 | 핵심 기능 문제 |

---

## 작업 시작 전 체크

- [x] 현재 코드 상태 git commit 완료 확인

---

## 작업 완료 내역

### 2026-01-27: 우선순위 1, 2 완료
- ✅ #4 엔티티 중복: common 모듈로 공유 코드 분리
- ✅ #7 BE-GH 통신: Redis Sorted Set 기반 job queue로 전환
- ✅ #8, #9 챌린지: Harvester에서 직접 계산 (BE 통신 불필요)
- 📝 관련 커밋: 9개 (harvester-redis-scheduler 작업)

### 2026-01-27: 우선순위 3 (Phase 1) 완료
- ✅ #1 코드 품질 개선 (KOSP 컨벤션 준수)
  - ScoreCalculationStep.java: 삼항 연산자 5개 제거, 긴 메서드 4개 분할
  - StatisticsAggregationStep.java: 삼항 연산자 4개 제거, 긴 메서드 3개 분할
  - 모든 메서드 ≤10줄 준수 (KOSP 규칙)
- ✅ #6 복잡한 코드 흐름 단순화 (2개 파일)
  - 긴 메서드를 작은 단위로 분리
  - Early return 패턴 적용
  - Helper 메서드 추출로 가독성 향상
- 📝 관련 커밋: 2개 (refactor/kosp-compliance-phase1 브랜치)

### 다음 작업: 우선순위 3 (Phase 2)
- [ ] 나머지 5개 Step 파일 리팩토링 (RepositoryDiscovery, PRMining, IssueMining, CommitMining, Cleanup)
- [ ] 공통 유틸리티 추출 및 중복 코드 제거
