# Harvester 리팩토링 이슈 목록

> 작성일: 2026-01-23
> 상태: 대기 중

---

## 1. 코드 품질 저하 (덕지덕지)

**현상:**
- 급하게 기능 추가하면서 코드가 지저분해짐
- 임시 해결책들이 누적됨
- 일관성 없는 패턴 혼재

**해결 방향:**
- [ ] 전체 코드 리뷰 후 정리 대상 파일 목록 작성
- [ ] AGENTS.md 코딩 컨벤션 재적용 (indent depth <= 1, no else, 10줄 이하)
- [ ] 중복 코드 추출 및 공통화

---

## 2. 데이터 수집 누락

**현상:**
- 일부 데이터가 수집되지 않음
- 어떤 데이터가 누락되는지 파악 필요

**조사 필요:**
- [ ] 어떤 종류의 데이터가 누락되는지 확인 (PR? Issue? Commit?)
- [ ] GraphQL 쿼리에서 빠진 필드 있는지 점검
- [ ] Step 실행 순서/의존성 문제 여부 확인

**해결 방향:**
- [ ] 누락 케이스 재현 및 로깅 추가
- [ ] 수집 완료 검증 로직 추가

---

## 3. 최근 활동 내역 수집 누락

**현상:**
- 최근 활동 (Recent Activity) 데이터가 전부 누락됨

**조사 필요:**
- [ ] RecentActivityStep 존재 여부 확인
- [ ] 어떤 활동 유형이 누락되는지 파악
- [ ] 페이지네이션 문제인지, 필터링 문제인지 확인

**해결 방향:**
- [ ] 활동 유형별 수집 로직 점검
- [ ] 누락 케이스에 대한 테스트 추가

---

## 4. BE-GH 간 엔티티/코드 중복

**현상:**
- 동일한 Entity 클래스가 Backend와 Harvester 양쪽에 존재
- 한쪽 수정 시 다른쪽 동기화 누락 가능성

**문제 파일들 (예상):**
- User / GithubUser 엔티티
- MongoDB Document 클래스들
- DTO 클래스들

**해결 방향:**
- [ ] 공유 모듈 (shared library) 분리
- [ ] 변경 시 양쪽 동기화 체크리스트 문서화

---

## 5. 대형 레포 타임아웃 / 조용한 실패

**현상:**
- 큰 레포지토리 수집 시 타임아웃 발생
- 실패해도 에러로 기록되지 않는 경우 있음 (silent failure)

**조사 필요:**
- [ ] 어느 Step에서 타임아웃 발생하는지 확인
- [ ] GraphQL 쿼리 타임아웃 설정 확인
- [ ] Exception이 catch만 되고 rethrow 안 되는 곳 찾기

**해결 방향:**
- [ ] 페이지네이션 개선 (한 번에 적은 양씩)
- [ ] 레포 크기 기반 분할 처리
- [ ] 실패 시 명확한 에러 로깅 및 Job 상태 반영
- [ ] retry 정책 추가

---

## 6. 복잡한 코드 흐름 (스파게티)

**현상:**
- 코드 흐름 추적이 어려움
- 어디서 뭐가 실행되는지 파악 힘듦
- 디버깅 시간 증가

**문제 영역 (예상):**
- Step 간 데이터 전달 방식
- Job/Step 구성 로직
- Redis Stream 메시지 처리 흐름

**해결 방향:**
- [ ] 아키텍처 다이어그램 작성
- [ ] Step 간 명확한 인터페이스 정의
- [ ] 복잡한 메서드 분리 및 단순화
- [ ] 흐름 추적용 로깅 개선

---

## 7. BE-GH 통신 구조 문제

**현상:**
- Backend와 Harvester 간 통신에 문제 많음
- 어떤 문제인지 구체화 필요

**조사 필요:**
- [ ] 현재 통신 방식 정리 (Redis Stream)
- [ ] stream이 안비워짐
- [ ] trigger에 쌓여도 실행 안됨 (이게 메시지 유실인가?)
- [ ] 메시지 유실 케이스 확인

**해결 방향:**
- [ ] 통신 프로토콜 단순화 (다른 프로토콜을 알아보던지 해야할듯)
- [ ] 메시지 포맷 명세 문서화
- [ ] 실패 시 재시도 / 복구 메커니즘 강화

---

## 8. 챌린지 업데이트 요청 발송 확인 불가

**현상:**
- Harvester가 BE로 챌린지 업데이트 요청을 보내는지 확인이 안 됨
- 로그가 눈에 안 띄어서 정상 동작 여부 파악 불가
- 요청이 실제로 나가는지, 실패하는지 모름

**조사 필요:**
- [ ] ChallengeCheckPublisher (또는 유사 클래스) 위치 확인
- [ ] 현재 로깅 수준 확인
- [ ] 실제 Redis Pub/Sub 메시지 발행 여부 확인

**해결 방향:**
- [ ] 챌린지 요청 발송 시 명확한 INFO 레벨 로그 추가
- [ ] 4번 항목의 해결방안인 공유 모듈 (shared library) 분리를 적용
- [ ] 공통 모듈 적용 후 Harvester에서 계산

---

## 9. BE 챌린지 요청 처리 검증 필요

**현상:**
- Backend가 챌린지 요청을 받아서 제대로 처리하는지 확인 안 됨
- GH → BE 요청은 나가는 것 같은데 BE에서 실제로 처리되는지 의문

**조사 필요:**
- [ ] BE의 챌린지 요청 수신 로직 위치 확인 (KOSP-Backend)
- [ ] BE에서 수신 로그 남기고 있는지 확인
- [ ] 챌린지 상태 업데이트가 DB에 반영되는지 확인

**해결 방향:**
- [ ] 4번 항목의 해결방안인 공유 모듈 (shared library) 분리를 적용
- [ ] 공통 모듈 적용 후 Harvester에서 계산

---

## 우선순위 (제안)

| 순위 | 이슈 | 이유 |
|----|------|------|
| 1  | #4 엔티티 중복 | 유지보수 리스크 |
| 2  | #7 BE-GH 통신 | 시스템 안정성 |
| 3  | #1, #6 코드 품질 | 장기적 생산성 |
| 4  | #8, #9 챌린지 요청 검증 | 기능 동작 확인 불가 |
| 5  | #5 대형 레포 타임아웃 | 데이터 손실 |
| 6  | #2, #3 데이터 수집 누락 | 핵심 기능 문제 |

---

## 작업 시작 전 체크

- [ ] 현재 코드 상태 git commit 완료 확인
